#! /bin/sh

set -e
set -x
export DEBIAN_FRONTEND=noninteractive

## install java and elasticsearch
apt-get install --no-install-recommends -y default-jre-headless elasticsearch

##
## download kibana, and extract to /opt/kibana
##
kibana_version=4.0.0
kibana_archive=kibana-${kibana_version}-linux-x64.tar.gz
cd /tmp
curl -LO https://download.elasticsearch.org/kibana/kibana/${kibana_archive}
mkdir -p /opt/kibana
tar xf /tmp/${kibana_archive} -C /opt/kibana --strip-components=1
rm /tmp/${kibana_archive}

##
## add system user "kibana" to run kibana process
##
addgroup --system kibana
adduser --system --home /opt/kibana --shell /bin/false --no-create-home \
  --gecos 'kibana' --ingroup kibana --disabled-password \
  kibana
chown -R kibana:kibana /opt/kibana

##
## install supervisor
## (see baseimage/tmp/build/es-kibana/opt/custom-installers)
##
/opt/custom-installers/supervisor/install.sh

##
## add kibana to supervisor
##
install -m 644 -o root -g root -p /tmp/build/es-kibana/etc/supervisor/conf.d/kibana.conf /etc/supervisor/conf.d/kibana.conf
etckeeper commit "supervisor: add kibana"

