#! /bin/sh

set -e
set -x

nginx_version="1.22.1"
nginx_pkg_version="${nginx_version}-1~bullseye"

## install gnupg
apt-get install -y --no-install-recommends gnupg

## install apt key
curl -sSf http://nginx.org/keys/nginx_signing.key | \
  gpg --no-default-keyring --keyring /usr/share/keyrings/nginx.gpg --import

## add apt-line
(
  echo "deb     [signed-by=/usr/share/keyrings/nginx.gpg] http://nginx.org/packages/debian/ bullseye nginx"
  echo "deb-src [signed-by=/usr/share/keyrings/nginx.gpg] http://nginx.org/packages/debian/ bullseye nginx"
  echo "deb     [signed-by=/usr/share/keyrings/nginx.gpg] http://nginx.org/packages/mainline/debian/ bullseye nginx"
  echo "deb-src [signed-by=/usr/share/keyrings/nginx.gpg] http://nginx.org/packages/mainline/debian/ bullseye nginx"
) | tee /etc/apt/sources.list.d/nginx.list

## install nginx build-dep
apt-get update
apt-get install -y --no-install-recommends build-essential fakeroot devscripts
apt-get build-dep -y --no-install-recommends nginx=${nginx_pkg_version}

## download nginx source code
apt-get source nginx=${nginx_pkg_version}

## rebuild nginx
cd nginx-${nginx_version}
debuild -b -uc -us

## cleanup
cd ..
rm -rf nginx-${nginx_version}

