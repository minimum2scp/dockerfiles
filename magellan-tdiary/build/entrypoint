#! /usr/bin/env ruby

if ENV['TDIARY_BASIC_AUTH_USERNAME'] && ENV['TDIARY_BASIC_AUTH_PASSWORD']
  system('rake -f /opt/magellan-tdiary/Rakefile htpasswd:create')
  ENV.delete('TDIARY_BASIC_AUTH_USERNAME')
  ENV.delete('TDIARY_BASIC_AUTH_PASSWORD')
end

if !ENV['MYSQL_HOST'] && ENV['DB_PORT_3306_TCP_ADDR']
  ENV['MYSQL_HOST'] = ENV['DB_PORT_3306_TCP_ADDR']
end

if !ENV['MYSQL_PORT'] && ENV['DB_PORT_3306_TCP_PORT']
  ENV['MYSQL_PORT'] = ENV['DB_PORT_3306_TCP_PORT']
end

if !ENV['DATABASE_URL'] && ENV['MYSQL_USERNAME'] && ENV['MYSQL_PASSWORD'] && ENV['MYSQL_HOST'] && ENV['MYSQL_PORT'] && ENV['MYSQL_DATABASE']
  ENV['DATABASE_URL'] = "mysql2://#{ENV['MYSQL_USERNAME']}:#{ENV['MYSQL_PASSWORD']}@#{ENV['MYSQL_HOST']}:#{ENV['MYSQL_PORT']}/#{ENV['MYSQL_DATABASE']}"
end

if ENV['DATABASE_URL']
  system('rake -f /opt/magellan-tdiary/Rakefile db:create')
end

if !ENV['REDIS_HOST'] && ENV['CACHE_PORT_6379_TCP_ADDR']
  ENV['REDIS_HOST'] = ENV['CACHE_PORT_6379_TCP_ADDR']
end

if !ENV['REDIS_PORT'] && ENV['CACHE_PORT_6379_TCP_PORT']
  ENV['REDIS_PORT'] = ENV['CACHE_PORT_6379_TCP_PORT']
end

if !ENV['REDIS_URL'] && ENV['REDIS_HOST']
  require 'uri'
  ENV['REDIS_URL'] = URI::Generic.build(scheme: "redis", host: ENV['REDIS_HOST'], port: (ENV['REDIS_PORT'] || 6379).to_i).tap{|o|
    o.user = ":#{ENV['REDIS_PASSWORD']}" if ENV['REDIS_PASSWORD']
    o.path = "/#{ENV['REDIS_DATABASE']}" if ENV['REDIS_DATABASE']
  }.to_s
end

program = ARGV.shift
exec(program, *ARGV)
