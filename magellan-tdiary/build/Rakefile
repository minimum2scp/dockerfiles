require 'logger'
require 'bundler/setup'
require 'sequel'
require 'webrick/httpauth/htpasswd'

logger = Logger.new($stdout)

namespace :db do
  desc "create database by environment variable DATABASE_URL"
  task :create do
    opts = Sequel.connect(ENV['DATABASE_URL']).opts
    opts.delete(:uri)
    dbname = opts.delete(:database)
    logger.info "Connect to #{opts.inspect}"
    Sequel.connect(opts, loggers: [logger])["CREATE DATABASE IF NOT EXISTS #{dbname}"].all
  end
end

namespace :htpasswd do
  desc "create .htpasswd by environment variable TDIARY_BASIC_AUTH_USERNAME, TDIARY_BASIC_AUTH_PASSWORD"
  task :create do
    htpasswd = WEBrick::HTTPAuth::Htpasswd.new('.htpasswd')
    htpasswd.set_passwd(nil, ENV['TDIARY_BASIC_AUTH_USERNAME'], ENV['TDIARY_BASIC_AUTH_PASSWORD'])
    htpasswd.flush
    logger.info "created .htaccess"
  end
end

